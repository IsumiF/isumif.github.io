<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>My Hakyll Blog - ghc-mod ELF 42 with yesod scaffolded site</title>
        <link rel="stylesheet" href="../../css/default.css" />
        <link rel="stylesheet" href="../../css/syntax.css" />
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../../">My Hakyll Blog</a>
            </div>
            <nav>
                <a href="../../">Home</a>
                <a href="../../about.html">About</a>
                <a href="../../contact.html">Contact</a>
                <a href="../../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>ghc-mod ELF 42 with yesod scaffolded site</h1>
            <article>
    <section class="header">
        Posted on September  2, 2017
        
    </section>
    <section>
        <h2 id="problem">Problem</h2>
<p>Recently, as I started working with Yesod’s scaffolded site, <code>ghc-mod</code> didn’t work. It reports an error like this:</p>
<pre><code>ghc-mod: /home/zelinf/.stack/snapshots/x86_64-linux/lts-9.2/8.0.2/lib/x86_64-linux-ghc-8.0.2/yaml-0.8.23.3-1Jrp8dCoYxM4ztwxVbJIUL/libHSyaml-0.8.23.3-1Jrp8dCoYxM4ztwxVbJIUL.a: unhandled ELF relocation(RelA) type 42

ghc-mod: Could not on-demand load symbol 'simple_document_start'

ghc-mod: /home/zelinf/.stack/snapshots/x86_64-linux/lts-9.2/8.0.2/lib/x86_64-linux-ghc-8.0.2/yaml-0.8.23.3-1Jrp8dCoYxM4ztwxVbJIUL/libHSyaml-0.8.23.3-1Jrp8dCoYxM4ztwxVbJIUL.a: unknown symbol `simple_document_start'
ghc-mod: Could not on-demand load symbol 'yamlzm0zi8zi23zi3zm1Jrp8dCoYxM4zztwxVbJIUL_TextziLibyaml_zdfShowEvent_closure'

ghc-mod: /home/zelinf/.stack/snapshots/x86_64-linux/lts-9.2/8.0.2/lib/x86_64-linux-ghc-8.0.2/yaml-0.8.23.3-1Jrp8dCoYxM4ztwxVbJIUL/libHSyaml-0.8.23.3-1Jrp8dCoYxM4ztwxVbJIUL.a: unknown symbol `yamlzm0zi8zi23zi3zm1Jrp8dCoYxM4zztwxVbJIUL_TextziLibyaml_zdfShowEvent_closure'
ghc-mod: Could not on-demand load symbol 'yamlzm0zi8zi23zi3zm1Jrp8dCoYxM4zztwxVbJIUL_DataziYamlziInternal_zdfExceptionParseException_closure'

ghc-mod: .stack-work/dist/x86_64-linux/Cabal-1.24.2.0/build/Settings.o: unknown symbol `yamlzm0zi8zi23zi3zm1Jrp8dCoYxM4zztwxVbJIUL_DataziYamlziInternal_zdfExceptionParseException_closure'</code></pre>
<p><code>binutils-2.26</code> (or some newer version) uses a new ELF relocation type, which ghc-mod can’t identify.</p>
<h2 id="solution">Solution</h2>
<p>One possible workaround is to compile packages that suffer this problem with ghc option <code>-opta-Wa,-mrelax-relocations=no</code> (no spaces after the comma). Detailed steps: 1. Identify which package suffers. From the error message above, we see it’s <code>yaml-0.8.23.3</code> in this case. (But it might be other packages) 2. Add</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">ghc-options:</span>
  <span class="fu">yaml:</span><span class="at"> -opta-Wa,-mrelax-relocations=no</span></code></pre></div>
<p>to your <code>stack.yaml</code>. The options will be passed to ghc while recompiling <code>yaml</code> 3. Force a recompilation</p>
<pre><code>stack exec -- ghc-pkg unregister yaml --force
stack build --force-dirty</code></pre>
<p>It should work fine now.</p>
<hr />
<p>References: <a href="https://github.com/DanielG/ghc-mod/issues/762">discussion</a> <a href="https://github.com/gibiansky/IHaskell/issues/636">workaround</a></p>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
